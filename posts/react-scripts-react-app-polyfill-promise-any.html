<!DOCTYPE html><html lang="ko"><head><meta charSet="utf-8"/><meta name="viewport" content="initial-scale=1.0, width=device-width"/><title>react-scripts 에서 Promise.any polyfill 추가하기</title><meta name="next-head-count" content="3"/><link rel="preconnect" href="https://fonts.googleapis.com"/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin=""/><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin /><link rel="preload" href="/_next/static/css/9d33c709da292899.css" as="style"/><link rel="stylesheet" href="/_next/static/css/9d33c709da292899.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-9b312e20a4e32339.js" defer=""></script><script src="/_next/static/chunks/framework-5f4595e5518b5600.js" defer=""></script><script src="/_next/static/chunks/main-a054bbf31fb90f6a.js" defer=""></script><script src="/_next/static/chunks/pages/_app-f8a3b6767a48f6a5.js" defer=""></script><script src="/_next/static/chunks/641-91ae8bb3644174ea.js" defer=""></script><script src="/_next/static/chunks/pages/posts/%5Bid%5D-a486052144ad5f7e.js" defer=""></script><script src="/_next/static/a8sbTVdd1DHjimNAJKuxI/_buildManifest.js" defer=""></script><script src="/_next/static/a8sbTVdd1DHjimNAJKuxI/_ssgManifest.js" defer=""></script><script src="/_next/static/a8sbTVdd1DHjimNAJKuxI/_middlewareManifest.js" defer=""></script><style data-styled="" data-styled-version="5.3.3">*,::before,::after{box-sizing:border-box;}/*!sc*/
[hidden]{display:none;}/*!sc*/
h1{margin:0.67em 0;font-size:2rem;}/*!sc*/
h2{font-size:1.5rem;}/*!sc*/
h3{font-size:1.17rem;}/*!sc*/
h4{font-size:1rem;}/*!sc*/
h5{font-size:0.83rem;}/*!sc*/
h6{font-size:0.67rem;}/*!sc*/
pre{white-space:pre-wrap;}/*!sc*/
hr{border-style:solid;border-width:1px 0 0;color:inherit;height:0;overflow:visible;}/*!sc*/
img,svg,video,canvas,audio,iframe,embed,object{display:block;vertical-align:middle;max-width:100%;}/*!sc*/
picture{display:contents;}/*!sc*/
source{display:none;}/*!sc*/
img,svg,video,canvas{height:auto;}/*!sc*/
audio{width:100%;}/*!sc*/
audio:not([controls]){display:none;}/*!sc*/
img{border-style:none;}/*!sc*/
svg{overflow:hidden;}/*!sc*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block;}/*!sc*/
[type="checkbox"],[type="radio"]{box-sizing:border-box;padding:0;}/*!sc*/
html,body{padding:0;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Apple SD Gothic Neo","Malgun Gothic","맑은 고딕","나눔고딕","Nanum Gothic","Noto Sans KR","Noto Sans CJK KR",arial,"돋움",Dotum,Tahoma,Geneva,"Helvetica Neue",sans-serif;}/*!sc*/
a{color:inherit;-webkit-text-decoration:none;text-decoration:none;}/*!sc*/
code[class*=language-],pre[class*=language-]{font-family:"Source Code Pro",Consolas,Menlo,Monaco,Courier New,monospace;font-size:0.825rem;}/*!sc*/
data-styled.g1[id="sc-global-jkJdhN1"]{content:"sc-global-jkJdhN1,"}/*!sc*/
.jzwiwO{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;width:100%;}/*!sc*/
data-styled.g2[id="sc-6d17420c-0"]{content:"jzwiwO,"}/*!sc*/
.hCxheK{margin:0;line-height:1.25;width:100%;font-weight:800;}/*!sc*/
data-styled.g3[id="sc-6d17420c-1"]{content:"hCxheK,"}/*!sc*/
.deSAmu{width:100%;font-size:3.6rem;text-align:center;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-column-gap:2rem;column-gap:2rem;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}/*!sc*/
.deSAmu:hover p span{box-shadow:0 0.25rem 0 0 black;}/*!sc*/
@media (max-width:767px){.deSAmu{font-size:9vw;-webkit-column-gap:1rem;column-gap:1rem;}}/*!sc*/
data-styled.g4[id="sc-6d17420c-2"]{content:"deSAmu,"}/*!sc*/
.iMxutK{position:relative;overflow:hidden;border-radius:35%;width:25%;padding-bottom:25%;}/*!sc*/
@media (max-width:600px){.iMxutK{width:20%;padding-bottom:20%;}}/*!sc*/
data-styled.g5[id="sc-6d17420c-3"]{content:"iMxutK,"}/*!sc*/
.hunNUo{position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;}/*!sc*/
data-styled.g6[id="sc-6d17420c-4"]{content:"hunNUo,"}/*!sc*/
.jzrTAN{min-height:100vh;padding:3rem 2rem 0;-webkit-flex:1;-ms-flex:1;flex:1;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;row-gap:2rem;max-width:768px;margin:auto;}/*!sc*/
@media (max-width:600px){.jzrTAN{padding:2rem 1rem 0;}}/*!sc*/
data-styled.g10[id="sc-436a7e6d-0"]{content:"jzrTAN,"}/*!sc*/
.fCWfQB{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;width:100%;padding:2rem 0 1rem;border-top:1px solid #eaeaea;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}/*!sc*/
data-styled.g11[id="sc-436a7e6d-1"]{content:"fCWfQB,"}/*!sc*/
.kLhcQd h2{font-size:2.5rem;margin:0 0 0.5rem;font-weight:800;}/*!sc*/
@media (max-width:600px){.kLhcQd h2{font-size:2rem;}}/*!sc*/
@media (max-width:375px){.kLhcQd h2{font-size:1.5rem;}}/*!sc*/
.kLhcQd time{font-size:1rem;}/*!sc*/
.kLhcQd p{font-size:1.25rem;line-height:1.75rem;}/*!sc*/
data-styled.g13[id="sc-564a7b06-1"]{content:"kLhcQd,"}/*!sc*/
.lmqIuX{width:100%;-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;line-height:1.75;}/*!sc*/
.lmqIuX a{word-break:break-word;}/*!sc*/
.lmqIuX a:hover{box-shadow:0 0.125rem 0 0 black;}/*!sc*/
.lmqIuX ul{margin:0;padding-inline-start:20px;}/*!sc*/
.lmqIuX :not(pre) > code{border-radius:0.3em;background:rgb(255 229 100 / 20%);color:#1a1a1a;padding:0.15em 0.2em 0.05em;white-space:normal;}/*!sc*/
.lmqIuX details > summary{cursor:pointer;}/*!sc*/
.lmqIuX blockquote{margin:0 1.75rem 1.75rem -1.75rem;padding:0 0 0 1.25rem;font-size:1.25rem;line-height:1.75rem;color:inherit;font-style:italic;border-left:0.3281rem solid hsl(0deg 0% 0% / 90%);border-left-color:inherit;opacity:0.8;}/*!sc*/
.lmqIuX table{display:block;width:100%;width:-webkit-max-content;width:-moz-max-content;width:max-content;max-width:100%;overflow:auto;margin-top:0;margin-bottom:1rem;border-spacing:0;border-collapse:collapse;}/*!sc*/
.lmqIuX table tr{border-top:1px solid hsl(210deg 18% 87% / 100%);}/*!sc*/
.lmqIuX table tr:nth-child(2n){background-color:#f6f8fa;}/*!sc*/
.lmqIuX table th{font-weight:600;}/*!sc*/
.lmqIuX table th,.lmqIuX table td{padding:6px 13px;border:1px solid #d0d7de;}/*!sc*/
data-styled.g14[id="sc-863196f3-0"]{content:"lmqIuX,"}/*!sc*/
</style><style data-href="https://fonts.googleapis.com/css2?family=Source+Code+Pro&display=swap">@font-face{font-family:'Source Code Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v21/HI_diYsKILxRpg3hIP6sJ7fM7PqPMcMnZFqUwX28DMyQhM0.woff) format('woff')}@font-face{font-family:'Source Code Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v21/HI_diYsKILxRpg3hIP6sJ7fM7PqPMcMnZFqUwX28DMyQtMRrSlcZZJmOpwVS.woff) format('woff');unicode-range:U+0460-052F,U+1C80-1C88,U+20B4,U+2DE0-2DFF,U+A640-A69F,U+FE2E-FE2F}@font-face{font-family:'Source Code Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v21/HI_diYsKILxRpg3hIP6sJ7fM7PqPMcMnZFqUwX28DMyQtM1rSlcZZJmOpwVS.woff) format('woff');unicode-range:U+0301,U+0400-045F,U+0490-0491,U+04B0-04B1,U+2116}@font-face{font-family:'Source Code Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v21/HI_diYsKILxRpg3hIP6sJ7fM7PqPMcMnZFqUwX28DMyQtMVrSlcZZJmOpwVS.woff) format('woff');unicode-range:U+1F00-1FFF}@font-face{font-family:'Source Code Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v21/HI_diYsKILxRpg3hIP6sJ7fM7PqPMcMnZFqUwX28DMyQtMprSlcZZJmOpwVS.woff) format('woff');unicode-range:U+0370-03FF}@font-face{font-family:'Source Code Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v21/HI_diYsKILxRpg3hIP6sJ7fM7PqPMcMnZFqUwX28DMyQtMZrSlcZZJmOpwVS.woff) format('woff');unicode-range:U+0102-0103,U+0110-0111,U+0128-0129,U+0168-0169,U+01A0-01A1,U+01AF-01B0,U+1EA0-1EF9,U+20AB}@font-face{font-family:'Source Code Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v21/HI_diYsKILxRpg3hIP6sJ7fM7PqPMcMnZFqUwX28DMyQtMdrSlcZZJmOpwVS.woff) format('woff');unicode-range:U+0100-024F,U+0259,U+1E00-1EFF,U+2020,U+20A0-20AB,U+20AD-20CF,U+2113,U+2C60-2C7F,U+A720-A7FF}@font-face{font-family:'Source Code Pro';font-style:normal;font-weight:400;font-display:swap;src:url(https://fonts.gstatic.com/s/sourcecodepro/v21/HI_diYsKILxRpg3hIP6sJ7fM7PqPMcMnZFqUwX28DMyQtMlrSlcZZJmOpw.woff) format('woff');unicode-range:U+0000-00FF,U+0131,U+0152-0153,U+02BB-02BC,U+02C6,U+02DA,U+02DC,U+2000-206F,U+2074,U+20AC,U+2122,U+2191,U+2193,U+2212,U+2215,U+FEFF,U+FFFD}</style></head><body><div id="__next" data-reactroot=""><div class="sc-436a7e6d-0 jzrTAN"><header class="sc-6d17420c-0 jzwiwO"><h1 class="sc-6d17420c-1 hCxheK"><a href="/" class="sc-6d17420c-2 deSAmu"><div class="sc-6d17420c-3 iMxutK"><picture><source srcSet="/profile.webp" type="image/webp"/><img src="/profile.jpg" alt="프로필" class="sc-6d17420c-4 hunNUo"/></picture></div><div><span>프론트엔드 개발자</span><br/><span>김동희입니다</span></div></a></h1></header><article class="sc-564a7b06-1 kLhcQd"><h2>react-scripts 에서 Promise.any polyfill 추가하기</h2><time>2022-06-01</time></article><main class="sc-863196f3-0 lmqIuX"><h2>I. 문제점</h2>
<p>iOS 13 버젼의 기기에서 <code>Promise.any is not a function.</code> TypeError가 발생하여 <code>Promise.any</code>를 사용하는 기능들이 동작하지 않는 이슈가 발생하였다.</p>
<p><code>react-app-polyfill</code>을 import 하고 있고, .browerslistrc 에 iOS 11 이상도 명시해두었기에 <code>Promise.any</code>의 polyfill도 자동으로 추가될 것이라 생각하였으나, 실제로는 추가되지 않은 것으로 보여졌다.</p>
<h3>현황</h3>
<pre><code class="hljs language-json"><span class="hljs-comment">// package.json</span>
<span class="hljs-attr">"dependencies"</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">{</span>
  <span class="hljs-attr">"react-scripts"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^5.0.0"</span><span class="hljs-punctuation">,</span>
  <span class="hljs-attr">"react-app-polyfill"</span><span class="hljs-punctuation">:</span> <span class="hljs-string">"^3.0.0"</span><span class="hljs-punctuation">,</span>
<span class="hljs-punctuation">}</span>
</code></pre>
<pre><code class="hljs language-tsx"><span class="hljs-comment">// index.tsx</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"react-app-polyfill"</span>;
</code></pre>
<h4><code>Promise.any</code>의 지원범위</h4>
<p><img src="https://user-images.githubusercontent.com/31029000/170509567-cd21e2e3-d0f1-4efe-b20f-a1d3ca5de839.png" alt="image"></p>
<h2>II. 해결책을 찾기 위한 접근방법</h2>
<h3>1. react-app-polyfill 의 동작방법 조사</h3>
<p><code>react-app-polyfill</code>은 <code>core-js/stable</code> 과 <code>runtime-generator</code> 를 import 하는 것이 동작의 전부이다.</p>
<p><code>runtime-generator</code>는 iterator-iterable 프로토콜과 관련된 polyfill 이므로, <code>Promise.any</code> 와는 전혀 관련이 없다.</p>
<p><code>core-js/stable</code>은 <code>core-js</code> 에 존재하는 수많은 polyfill 중 proposals를 제외한 stable한 기능의 polyfill만을 추가한다. 어떤 기능이 stable한 것인지는 <code>core-js</code> 버젼에 따라 상이하며, <a href="https://github.com/zloirock/core-js/blob/master/packages/core-js-compat/src/modules-by-versions.mjs">링크</a>에서 <code>core-js</code> 버젼별 stable한 기능을 확인할 수 있다.</p>
<h3>2. @babel/preset-env 동작방법 조사</h3>
<p><code>babel</code>은 트랜스파일 과정에서 <code>@babel/preset-env</code> 을 이용하여 기존의 코드를 target 환경에서 동작하는 구문으로 변경하는데, target 환경이 지원하지 않는 JS 최신 문법이라면 polyfill을 추가할 수 있다. 단, <code>core-js</code>를 import하는 것이 필수적이다.</p>
<p><code>@babel/preset-env</code>의 옵션 중 <code>useBuilltIns</code> 은 <code>@babel/preset-env</code> 가 어떻게 polyfill을 다룰 것인지 조정하는 옵션으로, <code>"usage" | "entry" | false</code> 의 값을 가질 수 있으며 default 값은 <code>false</code>이다. <code>false</code> 인 경우에는 polyfill을 추가하지 않는다.</p>
<h4>useBuiltIns: "usage"</h4>
<p><code>"usage"</code>로 설정한 경우, 기존의 코드에서 사용중인 기능을 target 환경에서 지원하지 않는다면 해당 기능에 대한 polyfill만 트랜스파일 시 추가한다.</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// 트랜스파일 전</span>
<span class="hljs-keyword">const</span> m = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
</code></pre>
<pre><code class="hljs language-js"><span class="hljs-comment">// 트랜스파일 후</span>

<span class="hljs-comment">// target 환경이 Map을 지원하지 않는 경우</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"core-js/modules/es.map"</span>;

<span class="hljs-keyword">const</span> m = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();

<span class="hljs-comment">// target 환경이 Map을 지원하는 경우</span>
<span class="hljs-keyword">const</span> m = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Map</span>();
</code></pre>
<h4>useBuiltIns: "entry"</h4>
<p><code>"entry"</code> 로 설정한 경우, 기존의 코드내에서 어떤 기능을 사용하는지 상관없이 target 환경이 지원하지 않는 모든 기능의 polyfill을 추가한다. 이 때 <code>@babel/preset-env</code>는 <code>import "core-js/stable";</code> 구문을 target 환경이 지원하지 않는 기능에 대한 polyfill 각각의 모듈 import로 변경한다.</p>
<pre><code class="hljs language-js"><span class="hljs-comment">// 트랜스파일 전</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"core-js/stable"</span>;
</code></pre>
<pre><code class="hljs language-js"><span class="hljs-comment">// 트랜스파일 후</span>
<span class="hljs-keyword">import</span> <span class="hljs-string">"core-js/modules/es.string.pad-start"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"core-js/modules/es.string.pad-end"</span>;
<span class="hljs-comment">// ...</span>
</code></pre>
<p>target 환경이 지원하지 않는 기능을 판단하기 위해 <code>@babel/preset-env</code>에 <code>"corejs"</code> 로 버젼을 지정할 수 있다. 실제로 설치된 <code>core-js</code> 버젼과 무관하게, 지정해준 <code>corejs</code> 버젼에 의해 어떤 polyfill의 import로 변경되는지가 결정된다.</p>
<p><a href="https://babeljs.io/docs/en/babel-preset-env#usebuiltins-entry">https://babeljs.io/docs/en/babel-preset-env#usebuiltins-entry</a></p>
<p><a href="https://babeljs.io/docs/en/babel-preset-env#corejs">https://babeljs.io/docs/en/babel-preset-env#corejs</a></p>
<h3>3. babel-preset-react-app 동작방법 조사</h3>
<p><code>react-scripts</code> 는 내부적으로 <code>babel-preset-react-app</code> 이라는 라이브러리를 사용해서 babel 의 각종 preset을 설정하고 있다.</p>
<p><code>babel-preset-react-app</code> 은 위에서 언급한 <code>@babel/preset-env</code> 외에도 <code>@babel/preset-react</code>, <code>@babel/preset-typescript</code> 등 각종 preset을 처리한다.</p>
<h2>III. 문제의 원인 파악</h2>
<p><code>babel-preset-react-app</code>은 <code>@babel/preset-env</code>를 설정할 때 다음과 같은 옵션값을 주고 있다.</p>
<pre><code class="hljs language-js">{
  <span class="hljs-attr">presets</span>: [
    <span class="hljs-comment">// Latest stable ECMAScript features</span>
    <span class="hljs-built_in">require</span>(<span class="hljs-string">"@babel/preset-env"</span>).<span class="hljs-property">default</span>,
    {
      <span class="hljs-comment">// Allow importing core-js in entrypoint and use browserlist to select polyfills</span>
      <span class="hljs-attr">useBuiltIns</span>: <span class="hljs-string">"entry"</span>,
      <span class="hljs-comment">// Set the corejs version we are using to avoid warnings in console</span>
      <span class="hljs-attr">corejs</span>: <span class="hljs-number">3</span>,
      <span class="hljs-comment">// Exclude transforms that make all code slower</span>
      <span class="hljs-attr">exclude</span>: [<span class="hljs-string">"transform-typeof-symbol"</span>],
    },
    <span class="hljs-comment">// ...</span>
  ];
}
</code></pre>
<p><code>@babel/preset-env</code> 의 옵션으로 <code>useBuiltins</code>에는 <code>"entry"</code>로, <code>corejs</code> 는 3을 할당하고 있다.</p>
<p>따라서 <code>import "react-app-polyfill"</code> 에 의해 import 되는 <code>"core-js/stable"</code>을 각각의 개별적인 polyfill 모듈으로 변환 할 때 corejs 3.0.0 을 기준으로 어떤 기능이 stable한지를 판단한다.
(3 은 문자열로 변환시 "3" 이고 이는 semver 기준 "3.0.0"을 의미함)</p>
<p><strong>corejs 3.7부터 <code>Promise.any</code>는 stable한 기능에 포함되기 때문에 <code>Promise.any</code>는 proposals에 해당하여 Promise.any에 대한 polyfill 은 추가되지 않았던 것이다.</strong></p>
<p><a href="https://github.com/zloirock/core-js/blob/master/packages/core-js-compat/src/modules-by-versions.mjs">https://github.com/zloirock/core-js/blob/master/packages/core-js-compat/src/modules-by-versions.mjs</a>)</p>
<h2>IV. 해결책</h2>
<p><code>react-app-rewired</code> 로 <code>react-scripts</code>의 <code>webpack</code> 설정을 변경할 수 있지만, <code>react-scripts</code>의 직접적인 <code>webpack</code> 설정이 아닌 <code>react-scripts</code>의 내부에서 사용되는 <code>babel-preset-react-app</code> 의 설정을 변경하여야 하므로, 불가능한 건 아니지만 매우 번거롭고 현실적으로 어렵다고 볼 수 있다.</p>
<p>따라서 core-js를 별도로 설치한 후에 <code>Promise.any</code>의 polyfill을 명시적으로 import 해준다.</p>
<pre><code class="hljs language-js"><span class="hljs-keyword">import</span> <span class="hljs-string">"core-js/proposals/promise-any"</span>;
<span class="hljs-keyword">import</span> <span class="hljs-string">"react-app-polyfill"</span>;
</code></pre>
<p><code>core-js</code> 3.0.0 기준 <code>Promise.any</code>는 proposals 이므로, <code>"core-js/proposals/promise-any"</code>를 import 한다.</p></main><script src="https://utteranc.es/client.js" repo="bigsaigon333/bigsaigon333.github.io" issue-term="title" theme="boxy-light" crossorigin="anonymous" async=""></script><footer class="sc-436a7e6d-1 fCWfQB">Copyright© 2022 All right reserved</footer></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"react-scripts-react-app-polyfill-promise-any","contentHtml":"\u003ch2\u003eI. 문제점\u003c/h2\u003e\n\u003cp\u003eiOS 13 버젼의 기기에서 \u003ccode\u003ePromise.any is not a function.\u003c/code\u003e TypeError가 발생하여 \u003ccode\u003ePromise.any\u003c/code\u003e를 사용하는 기능들이 동작하지 않는 이슈가 발생하였다.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ereact-app-polyfill\u003c/code\u003e을 import 하고 있고, .browerslistrc 에 iOS 11 이상도 명시해두었기에 \u003ccode\u003ePromise.any\u003c/code\u003e의 polyfill도 자동으로 추가될 것이라 생각하였으나, 실제로는 추가되지 않은 것으로 보여졌다.\u003c/p\u003e\n\u003ch3\u003e현황\u003c/h3\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-json\"\u003e\u003cspan class=\"hljs-comment\"\u003e// package.json\u003c/span\u003e\n\u003cspan class=\"hljs-attr\"\u003e\"dependencies\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-punctuation\"\u003e{\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\"react-scripts\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"^5.0.0\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n  \u003cspan class=\"hljs-attr\"\u003e\"react-app-polyfill\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e:\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"^3.0.0\"\u003c/span\u003e\u003cspan class=\"hljs-punctuation\"\u003e,\u003c/span\u003e\n\u003cspan class=\"hljs-punctuation\"\u003e}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-tsx\"\u003e\u003cspan class=\"hljs-comment\"\u003e// index.tsx\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"react-app-polyfill\"\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003e\u003ccode\u003ePromise.any\u003c/code\u003e의 지원범위\u003c/h4\u003e\n\u003cp\u003e\u003cimg src=\"https://user-images.githubusercontent.com/31029000/170509567-cd21e2e3-d0f1-4efe-b20f-a1d3ca5de839.png\" alt=\"image\"\u003e\u003c/p\u003e\n\u003ch2\u003eII. 해결책을 찾기 위한 접근방법\u003c/h2\u003e\n\u003ch3\u003e1. react-app-polyfill 의 동작방법 조사\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003ereact-app-polyfill\u003c/code\u003e은 \u003ccode\u003ecore-js/stable\u003c/code\u003e 과 \u003ccode\u003eruntime-generator\u003c/code\u003e 를 import 하는 것이 동작의 전부이다.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eruntime-generator\u003c/code\u003e는 iterator-iterable 프로토콜과 관련된 polyfill 이므로, \u003ccode\u003ePromise.any\u003c/code\u003e 와는 전혀 관련이 없다.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ecore-js/stable\u003c/code\u003e은 \u003ccode\u003ecore-js\u003c/code\u003e 에 존재하는 수많은 polyfill 중 proposals를 제외한 stable한 기능의 polyfill만을 추가한다. 어떤 기능이 stable한 것인지는 \u003ccode\u003ecore-js\u003c/code\u003e 버젼에 따라 상이하며, \u003ca href=\"https://github.com/zloirock/core-js/blob/master/packages/core-js-compat/src/modules-by-versions.mjs\"\u003e링크\u003c/a\u003e에서 \u003ccode\u003ecore-js\u003c/code\u003e 버젼별 stable한 기능을 확인할 수 있다.\u003c/p\u003e\n\u003ch3\u003e2. @babel/preset-env 동작방법 조사\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003ebabel\u003c/code\u003e은 트랜스파일 과정에서 \u003ccode\u003e@babel/preset-env\u003c/code\u003e 을 이용하여 기존의 코드를 target 환경에서 동작하는 구문으로 변경하는데, target 환경이 지원하지 않는 JS 최신 문법이라면 polyfill을 추가할 수 있다. 단, \u003ccode\u003ecore-js\u003c/code\u003e를 import하는 것이 필수적이다.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e@babel/preset-env\u003c/code\u003e의 옵션 중 \u003ccode\u003euseBuilltIns\u003c/code\u003e 은 \u003ccode\u003e@babel/preset-env\u003c/code\u003e 가 어떻게 polyfill을 다룰 것인지 조정하는 옵션으로, \u003ccode\u003e\"usage\" | \"entry\" | false\u003c/code\u003e 의 값을 가질 수 있으며 default 값은 \u003ccode\u003efalse\u003c/code\u003e이다. \u003ccode\u003efalse\u003c/code\u003e 인 경우에는 polyfill을 추가하지 않는다.\u003c/p\u003e\n\u003ch4\u003euseBuiltIns: \"usage\"\u003c/h4\u003e\n\u003cp\u003e\u003ccode\u003e\"usage\"\u003c/code\u003e로 설정한 경우, 기존의 코드에서 사용중인 기능을 target 환경에서 지원하지 않는다면 해당 기능에 대한 polyfill만 트랜스파일 시 추가한다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// 트랜스파일 전\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e m = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMap\u003c/span\u003e();\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// 트랜스파일 후\u003c/span\u003e\n\n\u003cspan class=\"hljs-comment\"\u003e// target 환경이 Map을 지원하지 않는 경우\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"core-js/modules/es.map\"\u003c/span\u003e;\n\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e m = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMap\u003c/span\u003e();\n\n\u003cspan class=\"hljs-comment\"\u003e// target 환경이 Map을 지원하는 경우\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003econst\u003c/span\u003e m = \u003cspan class=\"hljs-keyword\"\u003enew\u003c/span\u003e \u003cspan class=\"hljs-title class_\"\u003eMap\u003c/span\u003e();\n\u003c/code\u003e\u003c/pre\u003e\n\u003ch4\u003euseBuiltIns: \"entry\"\u003c/h4\u003e\n\u003cp\u003e\u003ccode\u003e\"entry\"\u003c/code\u003e 로 설정한 경우, 기존의 코드내에서 어떤 기능을 사용하는지 상관없이 target 환경이 지원하지 않는 모든 기능의 polyfill을 추가한다. 이 때 \u003ccode\u003e@babel/preset-env\u003c/code\u003e는 \u003ccode\u003eimport \"core-js/stable\";\u003c/code\u003e 구문을 target 환경이 지원하지 않는 기능에 대한 polyfill 각각의 모듈 import로 변경한다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// 트랜스파일 전\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"core-js/stable\"\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-comment\"\u003e// 트랜스파일 후\u003c/span\u003e\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"core-js/modules/es.string.pad-start\"\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"core-js/modules/es.string.pad-end\"\u003c/span\u003e;\n\u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003etarget 환경이 지원하지 않는 기능을 판단하기 위해 \u003ccode\u003e@babel/preset-env\u003c/code\u003e에 \u003ccode\u003e\"corejs\"\u003c/code\u003e 로 버젼을 지정할 수 있다. 실제로 설치된 \u003ccode\u003ecore-js\u003c/code\u003e 버젼과 무관하게, 지정해준 \u003ccode\u003ecorejs\u003c/code\u003e 버젼에 의해 어떤 polyfill의 import로 변경되는지가 결정된다.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://babeljs.io/docs/en/babel-preset-env#usebuiltins-entry\"\u003ehttps://babeljs.io/docs/en/babel-preset-env#usebuiltins-entry\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://babeljs.io/docs/en/babel-preset-env#corejs\"\u003ehttps://babeljs.io/docs/en/babel-preset-env#corejs\u003c/a\u003e\u003c/p\u003e\n\u003ch3\u003e3. babel-preset-react-app 동작방법 조사\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003ereact-scripts\u003c/code\u003e 는 내부적으로 \u003ccode\u003ebabel-preset-react-app\u003c/code\u003e 이라는 라이브러리를 사용해서 babel 의 각종 preset을 설정하고 있다.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003ebabel-preset-react-app\u003c/code\u003e 은 위에서 언급한 \u003ccode\u003e@babel/preset-env\u003c/code\u003e 외에도 \u003ccode\u003e@babel/preset-react\u003c/code\u003e, \u003ccode\u003e@babel/preset-typescript\u003c/code\u003e 등 각종 preset을 처리한다.\u003c/p\u003e\n\u003ch2\u003eIII. 문제의 원인 파악\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003ebabel-preset-react-app\u003c/code\u003e은 \u003ccode\u003e@babel/preset-env\u003c/code\u003e를 설정할 때 다음과 같은 옵션값을 주고 있다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e{\n  \u003cspan class=\"hljs-attr\"\u003epresets\u003c/span\u003e: [\n    \u003cspan class=\"hljs-comment\"\u003e// Latest stable ECMAScript features\u003c/span\u003e\n    \u003cspan class=\"hljs-built_in\"\u003erequire\u003c/span\u003e(\u003cspan class=\"hljs-string\"\u003e\"@babel/preset-env\"\u003c/span\u003e).\u003cspan class=\"hljs-property\"\u003edefault\u003c/span\u003e,\n    {\n      \u003cspan class=\"hljs-comment\"\u003e// Allow importing core-js in entrypoint and use browserlist to select polyfills\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003euseBuiltIns\u003c/span\u003e: \u003cspan class=\"hljs-string\"\u003e\"entry\"\u003c/span\u003e,\n      \u003cspan class=\"hljs-comment\"\u003e// Set the corejs version we are using to avoid warnings in console\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003ecorejs\u003c/span\u003e: \u003cspan class=\"hljs-number\"\u003e3\u003c/span\u003e,\n      \u003cspan class=\"hljs-comment\"\u003e// Exclude transforms that make all code slower\u003c/span\u003e\n      \u003cspan class=\"hljs-attr\"\u003eexclude\u003c/span\u003e: [\u003cspan class=\"hljs-string\"\u003e\"transform-typeof-symbol\"\u003c/span\u003e],\n    },\n    \u003cspan class=\"hljs-comment\"\u003e// ...\u003c/span\u003e\n  ];\n}\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003e@babel/preset-env\u003c/code\u003e 의 옵션으로 \u003ccode\u003euseBuiltins\u003c/code\u003e에는 \u003ccode\u003e\"entry\"\u003c/code\u003e로, \u003ccode\u003ecorejs\u003c/code\u003e 는 3을 할당하고 있다.\u003c/p\u003e\n\u003cp\u003e따라서 \u003ccode\u003eimport \"react-app-polyfill\"\u003c/code\u003e 에 의해 import 되는 \u003ccode\u003e\"core-js/stable\"\u003c/code\u003e을 각각의 개별적인 polyfill 모듈으로 변환 할 때 corejs 3.0.0 을 기준으로 어떤 기능이 stable한지를 판단한다.\n(3 은 문자열로 변환시 \"3\" 이고 이는 semver 기준 \"3.0.0\"을 의미함)\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003ecorejs 3.7부터 \u003ccode\u003ePromise.any\u003c/code\u003e는 stable한 기능에 포함되기 때문에 \u003ccode\u003ePromise.any\u003c/code\u003e는 proposals에 해당하여 Promise.any에 대한 polyfill 은 추가되지 않았던 것이다.\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/zloirock/core-js/blob/master/packages/core-js-compat/src/modules-by-versions.mjs\"\u003ehttps://github.com/zloirock/core-js/blob/master/packages/core-js-compat/src/modules-by-versions.mjs\u003c/a\u003e)\u003c/p\u003e\n\u003ch2\u003eIV. 해결책\u003c/h2\u003e\n\u003cp\u003e\u003ccode\u003ereact-app-rewired\u003c/code\u003e 로 \u003ccode\u003ereact-scripts\u003c/code\u003e의 \u003ccode\u003ewebpack\u003c/code\u003e 설정을 변경할 수 있지만, \u003ccode\u003ereact-scripts\u003c/code\u003e의 직접적인 \u003ccode\u003ewebpack\u003c/code\u003e 설정이 아닌 \u003ccode\u003ereact-scripts\u003c/code\u003e의 내부에서 사용되는 \u003ccode\u003ebabel-preset-react-app\u003c/code\u003e 의 설정을 변경하여야 하므로, 불가능한 건 아니지만 매우 번거롭고 현실적으로 어렵다고 볼 수 있다.\u003c/p\u003e\n\u003cp\u003e따라서 core-js를 별도로 설치한 후에 \u003ccode\u003ePromise.any\u003c/code\u003e의 polyfill을 명시적으로 import 해준다.\u003c/p\u003e\n\u003cpre\u003e\u003ccode class=\"hljs language-js\"\u003e\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"core-js/proposals/promise-any\"\u003c/span\u003e;\n\u003cspan class=\"hljs-keyword\"\u003eimport\u003c/span\u003e \u003cspan class=\"hljs-string\"\u003e\"react-app-polyfill\"\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003e\u003ccode\u003ecore-js\u003c/code\u003e 3.0.0 기준 \u003ccode\u003ePromise.any\u003c/code\u003e는 proposals 이므로, \u003ccode\u003e\"core-js/proposals/promise-any\"\u003c/code\u003e를 import 한다.\u003c/p\u003e","title":"react-scripts 에서 Promise.any polyfill 추가하기","date":"2022-06-01"}},"__N_SSG":true},"page":"/posts/[id]","query":{"id":"react-scripts-react-app-polyfill-promise-any"},"buildId":"a8sbTVdd1DHjimNAJKuxI","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>